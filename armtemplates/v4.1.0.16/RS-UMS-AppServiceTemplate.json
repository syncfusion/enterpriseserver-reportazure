{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "SelectAppServiceNeedToDeploy": {
      "type": "string",
      "allowedValues": [
        "Report Server",
        "User Management Server",
        "Report Server with User Management Server"
      ],
      "metadata": {
        "description": "Select the Application that need to be deployed."
      }
    },
    "StorageType": {
      "type": "string",
      "allowedValues": [
        "FileStorage",
        "AzureBlobStorage"
      ],
      "metadata": {
        "description": "Choose a storage type for storing files the Report Server generates. A complete list of files generated by the Report Server can be viewed <a target='_blank' href='https://help.syncfusion.com/Report-platform/Report-server/faq#what-all-are-the-files-and-folders-will-be-generated-in-the-installed-machine'>here</a>."
      },
      "defaultValue": "FileStorage"
    },
    "AppServiceName": {
      "type": "string",
      "metadata": {
        "description": "Web App name for User Management Server/Report Server. The name must be between 3 and 24 characters long, and can contain only numbers and lowercase letters."
      }
    },
    "BlobStorageName": {
      "maxLength": 24,
      "minLength": 3,
      "type": "string",
      "metadata": {
        "description": "Storage account name for storing files the Report/User Management Server generates. The name must be between 3 to 24 characters long, and can contain only numbers and lowercase letters."
      },
      "defaultValue": "storageaccountname"
    },
    "BlobStorageAccountType": {
      "type": "string",
      "defaultValue": "Standard_LRS",
      "allowedValues": [
        "Standard_LRS",
        "Standard_ZRS",
        "Standard_GRS",
        "Standard_RAGRS",
        "Premium_LRS"
      ]
    }
  },
  "variables": {
    "AppServiceType": {
      "Report Server": "RS",
      "User Management Server": "UMS",
      "Report Server with User Management Server": "RS-UMS"
    },
    "SelectAppServiceNeedToDeploy": "[variables('AppServiceType')[parameters('SelectAppServiceNeedToDeploy')]]",
    "templatelink": "[concat('https://raw.githubusercontent.com/syncfusion/enterpriseserver-reportazure/master/armtemplates/v4.1.0.16/',parameters('storageType'),'-ReportServer.json')]",
    "rsGithubUrl": "https://github.com/syncfusion/enterpriseserver-reportazure.git",
    "umsGithubUrl": "https://github.com/SyncfusionInstall/enterpriseserver-umsazure.git",
    "rsReleaseVersion": "v4.1.0.16",
    "umsReleaseVersion": "v3.1.0.18",
    "appSvcPlanSkuName": "B1",
    "appSvcPlanName": "SyncfusionAppSvcPlan",
    "RS": {
      "alwaysOn": true,
      "netFrameworkVersion": "v4.6",
      "remoteDebuggingEnabled": false,
      "remoteDebuggingVersion": "VS2015",
      "use32BitWorkerProcess": true,
      "virtualApplications": [
              {
                "virtualPath": "/",
                "physicalPath": "site\\wwwroot"
              },
              {
                "virtualPath": "/API",
                "physicalPath": "site\\wwwroot\\API"
              },
              {
                "virtualPath": "/ReportService",
                "physicalPath": "site\\wwwroot\\ReportService"
              }
            ],
      "webSocketsEnabled": true
    },
    "UMS": {
      "alwaysOn": true,
      "netFrameworkVersion": "v4.6",
      "remoteDebuggingEnabled": false,
      "remoteDebuggingVersion": "VS2015",
      "use32BitWorkerProcess": true,
      "virtualApplications": [
        {
          "virtualPath": "/",
          "physicalPath": "site\\wwwroot"
        },
        {
          "virtualPath": "/API",
          "physicalPath": "site\\wwwroot\\API"
        }
      ],
      "webSocketsEnabled": true
    }
  },
  "resources": [
    {
      "apiVersion": "2015-01-01",
      "condition": "[or(equals(variables('SelectAppServiceNeedToDeploy'), 'RS'), equals(variables('SelectAppServiceNeedToDeploy'), 'UMS'))]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/serverfarms', variables('appSvcPlanName'))]"
      ],
      "name": "UMS-RS",
      "properties": {
        "mode": "Incremental",
        "parameters": {
          "AppServiceName": { "value": "[parameters('AppServiceName')]" },
          "AppServicePlanLocation": { "value": "[resourceGroup().location]" },
          "AppServicePlanResourceGroup": { "value": "[resourceGroup().name]" },
          "AppServiceType": { "value": "[variables('SelectAppServiceNeedToDeploy')]" },
          "BlobStorageAccountType": { "value": "[parameters('BlobStorageAccountType')]" },
          "BlobStorageName": { "value": "[parameters('BlobStorageName')]" },
          "deploySiteSettings": { "value": "[variables(variables('SelectAppServiceNeedToDeploy'))]" },
          "GithubURL": { "value": "[variables(concat(toLower(variables('SelectAppServiceNeedToDeploy')),'GithubUrl'))]" },
          "ReleaseVersion": { "value": "[variables(concat(toLower(variables('SelectAppServiceNeedToDeploy')),'ReleaseVersion'))]" },
          "StorageType": { "value": "[parameters('StorageType')]" }
        },
        "templateLink": {
          "uri": "[variables('templatelink')]",
          "contentVersion": "1.0.0.0"
        }
      },
      "type": "Microsoft.Resources/deployments"
    },
    {
      "apiVersion": "2015-01-01",
      "condition": "[equals(variables('SelectAppServiceNeedToDeploy'), 'RS-UMS')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/serverfarms', variables('appSvcPlanName'))]"
      ],
      "name": "UMS",
      "properties": {
        "mode": "Incremental",
		"templateLink": {
          "uri": "[variables('templatelink')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "AppServiceName": { "value": "[concat(parameters('AppServiceName'),'-ums')]" },
          "AppServicePlanLocation": { "value": "[resourceGroup().location]" },
          "AppServicePlanResourceGroup": { "value": "[resourceGroup().name]" },
          "AppServiceType": { "value": "UMS" },
          "BlobStorageAccountType": { "value": "[parameters('BlobStorageAccountType')]" },
          "BlobStorageName": { "value": "[parameters('BlobStorageName')]" },
          "deploySiteSettings": { "value": "[variables('UMS')]" },
          "GithubURL": { "value": "[variables('umsGithubUrl')]" },
          "ReleaseVersion": { "value": "[variables('umsReleaseVersion')]" },
          "StorageType": { "value": "[parameters('StorageType')]" }
        }
      },
      "type": "Microsoft.Resources/deployments"
    },
    {
      "apiVersion": "2015-01-01",
      "condition": "[equals(variables('SelectAppServiceNeedToDeploy'), 'RS-UMS')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/serverfarms', variables('appSvcPlanName'))]"
      ],
      "name": "RS",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('templatelink')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "AppServiceName": { "value": "[parameters('AppServiceName')]" },
          "AppServicePlanLocation": { "value": "[resourceGroup().location]" },
          "AppServicePlanResourceGroup": { "value": "[resourceGroup().name]" },
          "AppServiceType": { "value": "RS" },
          "BlobStorageAccountType": { "value": "[parameters('BlobStorageAccountType')]" },
          "BlobStorageName": { "value": "[parameters('BlobStorageName')]" },
          "deploySiteSettings": { "value": "[variables('RS')]" },
          "GithubURL": { "value": "[variables('rsGithubUrl')]" },
          "ReleaseVersion": { "value": "[variables('rsReleaseVersion')]" },
          "StorageType": { "value": "[parameters('StorageType')]" }
        }
      },
      "type": "Microsoft.Resources/deployments"
    },
    {
      "apiVersion": "2015-08-01",
      "dependsOn": [],
      "location": "[resourceGroup().location]",
      "name": "[variables('appSvcPlanName')]",
      "properties": {
        "name": "[variables('appSvcPlanName')]",
        "numberOfWorkers": 1
      },
      "sku": {
        "name": "[variables('appSvcPlanSkuName')]"
      },
      "tags": {
        "displayName": "SyncfusionAppServicePlan"
      },
      "type": "Microsoft.Web/serverfarms"
    }
  ]
}